---
- name: Check if /swapfile exists
  stat:
    path: /swapfile
  register: swapfile_stat

- name: Fallocate /swapfile
  command: fallocate -l {{ prairie_swap_size }} /swapfile
  when: not swapfile_stat.stat.exists

- name: Set /swapfile permissions
  file:
    path: /swapfile
    owner: root
    group: root
    mode: "0600"

- name: Create /swapfile
  command: mkswap /swapfile
  when: not swapfile_stat.stat.exists

- name: Check if /swapfile is already active
  command: grep -q '^/swapfile ' /proc/swaps
  register: swap_active
  failed_when: false
  changed_when: false

- name: Enable /swapfile
  command: swapon /swapfile
  when: swap_active.rc != 0

- name: Add /swapfile to /etc/fstab
  mount:
    name: none
    src: /swapfile
    fstype: swap
    opts: sw
    passno: "0"
    dump: "0"
    state: present

- name: Set swappiness
  sysctl:
    name: vm.swappiness
    value: "{{ prairie_swappiness }}"
    state: present
    reload: yes
